<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta http-equiv="x-dns-prefetch-control" content="off">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>running</title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<style type="text/css">
    html,body{
        height: 100%;
    }
    .container-fluid{
        height: 100%;
    }
    .row{
        height: 100%;
    }
    .col-xs-2,.col-xs-10{
        height: 100%;
    }
    .col-xs-2{
        overflow: auto;
        overflow-x: hidden;
    }
    #msgList{
        height: 80%;
        overflow-y: auto;
        overflow-x: hidden;
        word-break: break-all;
    }
</style>
<div class="container-fluid">
    <h3>用户名：<span id="userName"></span></h3>
    <div class="row">
        <div id="userList" class="col-xs-2">
            <ul class="list-group"></ul>
        </div>
        <div class="col-xs-10">
            <div id="msgList" class="col-xs-12"></div>

            <form class="form-inline">
                <div class="form-group">
                    <label for="to">TO</label> <input type="text" class="form-control" id="to" value=""/>
                </div>
                <div class="form-group">
                    <label for="say">Say</label> <input type="text" class="form-control" id="say" value=""/>
                    <input type="button" id="btnSendMsg" class="btn btn-default" value="send" onclick="sendMsg()"/>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="//cdn.bootcss.com/socket.io/1.3.6/socket.io.min.js"></script>
<script>
    var socket = '';
    var msg = '';
    var flag = false;
    var d = new Date();
    var month = d.getMonth() + 1;
    var date = d.getDate();
    var hours = d.getHours();
    var minutes = d.getMinutes();
    var seconds = d.getSeconds();
    var random = parseInt(Math.random() * 10);

    var user = 'Node' + month + date + hours + minutes + seconds + random;

    $(function () {
        $('#userName').text(user);
        $('#say').focus();

        socket = io.connect('http://localhost:3000');

        socket.emit('login', {
            username: user
        });

        socket.on('connect', function () {

            socket.on('client', function (data) {
                console.log(data);

                if (!data.from || !data.to || !data.msg) {
                    return false;
                }

                var obj = document.getElementById('msgList');
                var $obj = $(obj);

                var msgs = '<a href="javascript:void(0)" class="btn-link">' + data.from + '</a>';
                msgs += '对<a href="javascript:void(0)" class="btn-link">' + data.to + '</a>';
                msgs += '说：' + data.msg;
                $obj.append('<p>' + msgs + '</p>');

                var scrollH = $obj[0].scrollHeight;
                $obj.scrollTop(scrollH);
            });

            socket.on('client_user_list', function (data) {
                console.log(data);

                if (!data == '') {
                    var len = data.length;

                    $('#userList ul').html('');

                    for (var i = 0; i < len; i++) {
                        var currTime = parseInt(new Date().getTime() / 1000);
                        var lastTime = data[i].lastaction;

                        var time = currTime - lastTime;

                        var html = '<li class="list-group-item">';
                        html += '<a href="javascript:void(0)">';
                        html += data[i].username;
                        html += '</a>';
                        html += '<p>最后一次发言：' + time + '秒前</p>';
                        html += '</li>';

                        $('#userList ul').append(html);
                    }
                }
            });
        });

        $('#say').on('keydown', function (e) {
            if (e.keyCode == 13) {
                $('#btnSendMsg').click();
            }
        });
    });

    function sendMsg() {
        if ($.trim(user) == '') {
            alert('请刷新页面，输入正确用户名。');
            return false;
        }
        var oTo = document.getElementById('to');
        var oMsg = document.getElementById('say');
        var to = oTo.value;
        var msg = oMsg.value;

        if (msg == '') {
            alert('is empty!');
            return false;
        }

        if ($.trim(to) == '') {
            to = '大家';
        }

        flag = true;

        socket.emit('server', {
            from: user,
            to: to,
            msg: msg
        });

        oMsg.value = '';
        $(oMsg).focus();
    }

    window.onbeforeunload = function () {
        socket.emit('logon', {
            username: user
        });
    }
</script>
</body>
</html>